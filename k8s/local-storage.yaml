---
# StorageClass for local volumes
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Retain
---
# DaemonSet to prepare local storage directories on each node
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: local-volume-provisioner
  namespace: kube-system
  labels:
    app: local-volume-provisioner
spec:
  selector:
    matchLabels:
      app: local-volume-provisioner
  template:
    metadata:
      labels:
        app: local-volume-provisioner
    spec:
      serviceAccountName: local-storage-admin
      hostNetwork: true
      hostPID: true
      initContainers:
      - name: setup-directories
        image: busybox
        command:
        - sh
        - -c
        - |
          # Create local storage directories on each node
          mkdir -p /mnt/disks/local-storage/postgres
          mkdir -p /mnt/disks/local-storage/redis
          mkdir -p /mnt/disks/local-storage/kafka
          mkdir -p /mnt/disks/local-storage/minio
          mkdir -p /mnt/disks/local-storage/grafana
          mkdir -p /mnt/disks/local-storage/prometheus
          chmod -R 777 /mnt/disks/local-storage
          echo "Local storage directories created on $(hostname)"
        securityContext:
          privileged: true
        volumeMounts:
        - name: local-storage
          mountPath: /mnt/disks
          mountPropagation: Bidirectional
      containers:
      - name: provisioner
        image: busybox
        command:
        - sh
        - -c
        - |
          echo "Local storage provisioner running on $(hostname)"
          # Keep the container running
          while true; do sleep 3600; done
        securityContext:
          privileged: true
        volumeMounts:
        - name: local-storage
          mountPath: /mnt/disks
          mountPropagation: Bidirectional
      volumes:
      - name: local-storage
        hostPath:
          path: /mnt/disks
          type: DirectoryOrCreate
---
# ServiceAccount for provisioner
apiVersion: v1
kind: ServiceAccount
metadata:
  name: local-storage-admin
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: local-storage-provisioner
rules:
- apiGroups: [""]
  resources: ["persistentvolumes"]
  verbs: ["get", "list", "watch", "create", "delete"]
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["storage.k8s.io"]
  resources: ["storageclasses"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: local-storage-provisioner
subjects:
- kind: ServiceAccount
  name: local-storage-admin
  namespace: kube-system
roleRef:
  kind: ClusterRole
  name: local-storage-provisioner
  apiGroup: rbac.authorization.k8s.io
---
# Local PersistentVolumes - Create one per node for PostgreSQL
# These will be manually created after nodes are labeled
# Example for worker-1
apiVersion: v1
kind: PersistentVolume
metadata:
  name: local-pv-postgres-worker-1
spec:
  capacity:
    storage: 15Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-storage
  local:
    path: /mnt/disks/local-storage/postgres
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - lootchat-worker-1  # Update with actual node name
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: local-pv-redis-worker-2
spec:
  capacity:
    storage: 10Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-storage
  local:
    path: /mnt/disks/local-storage/redis
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - lootchat-worker-2
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: local-pv-kafka-worker-3
spec:
  capacity:
    storage: 15Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-storage
  local:
    path: /mnt/disks/local-storage/kafka
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - lootchat-worker-3
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: local-pv-minio-worker-4
spec:
  capacity:
    storage: 15Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-storage
  local:
    path: /mnt/disks/local-storage/minio
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - lootchat-worker-4 
